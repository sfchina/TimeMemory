<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>Time Memory</title>
	<link href="css/ui-lightness/jquery-ui-1.10.4.custom.css" rel="stylesheet">
	<script src="js/lib/jquery-2.1.0.js"></script>
	<script src="js/lib/jquery-ui-1.10.4.custom.js"></script>
	<script src="js/util.js"></script>
	<script>
	$(function(){
		//$( "#timelapse" ).accordion();
		$( "#dialog-link, #icons li" ).hover(
			function() {
				$( this ).addClass( "ui-state-hover" );
			},
			function() {
				$( this ).removeClass( "ui-state-hover" );
			}
		);
		$(".ui-icon-refresh").click(function(){
			refreshResult();
		});
		
		$(".ui-icon-circle-triangle-e").click(function(){
			captureImage();
		});
		
		var widget = null;
		var refreshResult=function(){
			$.ajax({url:'/target/captured.json',dataType:'json'
				,error:function(XMLHttpRequest, textStatus, errorThrown){
					
				}
				,success:function(result){
		         if(result.datas){
		        	 var container=$('#container');
		        	 var target='';
		        	 var tempDayId;
		        	 var count=0;
		        	 
		        	 var tempHeader;
		        	 var tempContainer;
		        	 $(result.datas).each(function(index,data){
		        		 var values=data.split('-');
		        		 var dayId=values.slice(0,3).join('-');
		        		 var imgId=data.substr(0,data.length-4);
		        		 
		        		 if(dayId!=tempDayId){
		        			 tempDayId=dayId;
		        			 tempContainer=$('#'+dayId);
		        			 if(tempContainer.length==0){
			        			 tempHeader=$('<h3">'+dayId+'</h3><div></div>');
			        			 tempContainer=$('<div id="'+dayId+'"></div>');
			        			 $("#timelapse").append(tempHeader).append(tempContainer); 
			        			 count=0;
		        			 }
		        		 }
		        		 count+=1; 
		        		 var imgObj=tempContainer.find('#'+imgId);
		        		 if(imgObj.length==0){
		        			 tempContainer.append($('<img src="/target/'+data+'" class="captureimg" id="'+imgId+'"/>'));
			        		 if(count%4==0){
			        			 tempContainer.append($('<br />'));
			        		 }
		        		 }
		        	 });
		        	 if(!widget){
		        		 widget=$("#timelapse").accordion();
		        	 }else{
		        		 $("#timelapse").accordion("refresh");
		        	 }
		        	 
		         }
		      	}
				,complete:function(XMLHttpRequest, textStatus){
					
				}
				});
		};

		var captureImage=function(){
			$.ajax({url:'/serv/capture_image',dataType:'json'
				,error:function(XMLHttpRequest, textStatus, errorThrown){
					$("#realtimeCapture").html(errorThrown);
					$("#realtimeCapture").dialog();
				}
				,success:function(result){
					if(result.rc=="ok"){
						var realImg='<img id="realtimeImg" style="width:100%;height:100px" src="data:image/png;base64,'
								+result.data.img+'"/>';
						$("#realtimeCapture").html(realImg);
					}else{
						$("#realtimeCapture").html(result.rm);
					}
					$( "#realtimeCapture" ).dialog();
		      	}
				,complete:function(XMLHttpRequest, textStatus){
					
				}
				});
		};
		
		refreshResult();
		var inID=setInterval(refreshResult, 5*60*1000);//refresh images list per 5 minite
		//clearInterval(inID);
	});
	</script>
		<style>
	body{
		font: 62.5% "Trebuchet MS", sans-serif;
		margin: 50px;
	}
	#icons {
		margin: 0;
		padding: 0;
	}
	#icons li {
		margin: 2px;
		position: relative;
		padding: 4px 0;
		cursor: pointer;
		float: left;
		list-style: none;
	}
	#icons span.ui-icon {
		float: left;
		margin: 0 4px;
	}
	.fakewindowcontain .ui-widget-overlay {
		position: absolute;
	}
	.captureimg{
		width:240px;
		height:180px;
	}
	</style>
</head>
<body>
<ul id="icons" class="ui-widget ui-helper-clearfix">
	<li class="ui-state-default ui-corner-all" title=".ui-icon-refresh"><span class="ui-icon ui-icon-refresh"></span></li>
	<li class="ui-state-default ui-corner-all" title=".ui-icon-circle-triangle-e"><span class="ui-icon ui-icon-circle-triangle-e"></span></li>

</ul>
<div id="container">
<div id="timelapse">

</div>
</div>

<div id="realtimeCapture" title="RealTime Capture" style="width:400%;height:400px">

</div>
</body>
</html>
